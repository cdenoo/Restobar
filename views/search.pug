extends basiclayout

block headcontent
    style.
        h2 {
            text-align: center;
        }
        #searchFilters{
            padding-bottom: 2em;
        }
        #searchFilters label{
            display: block;
        }
        #searchFilters label input {
            margin-right: 0.5em;
        }

block bodycontent

    .row.col-md-8.col-centered
        #searchFilters.col-sm-5.col-md-3
            h2 Filter the Results

            input.form-control(id="query" type="text" value=query name="query" placeholder="Search For...")

            h3 Types
            each type in types
                label(for="venue_type_" + type.type_id)
                    input(type="checkbox" name="venue_type_" + type.type_id value="1")
                    | #{type.type_name}

            h3 Features
            each feature in features
                label(for="feature_" + feature.feature_id)
                    input(type="checkbox" name="feature_" + feature.feature_id value="1")
                    | #{feature.name}

            h3 Location
            input.form-control(id="country" type="text" name="country" placeholder="Country")
            input.form-control(id="city" type="text" name="city" placeholder="City")

        .col-sm-7.col-md-9
            if errors
                each error in errors
                    .error.bg-danger #{error}

            h2 Results

            #searchResults
                p(style="text-align: center;") We are loading the results. Please wait...

    script.
        function getSearchResults(){

            //Gather all field values in one object
            function getFieldValues(){

                var result = {};

                $("#searchFilters input").each(function(index){

                    //Checkboxes need to be checked, otherwise we don't include them in the request
                    if($(this).attr("type") == "checkbox" && !$(this).prop("checked")){
                        return;
                    }

                    result[$(this).attr("name")] = $(this).val();
                });

                return result;
            }

            function requestError(internalError, userFriendlyError) {
                console.log("ajax response error: " + internalError);
                $("#searchResults").html("<p class='error bg-danger'>An error occurred while loading the results. Please try again." + (userFriendlyError ? "<br>More info: " + userFriendlyError : "") + "</p>");
            }

            function loadResults() {
                $.post({ //Shorthand for a jquery ajax post request
                    url: "/search",
                    data: getFieldValues(),
                    dataType: 'json',
                    success: function (response) {
                        if (response[0] == "ERROR") {
                            requestError(response[1], response[1]);
                        }
                        else if (response[0] == "SUCCESS") {

                            var venues = response[1];

                            for (id in venues) {

                                console.log(venues[id]);

                            }

                        }
                        else {
                            requestError("Unknown status: " + response);
                        }
                    }
                });
            }

            loadResults();
        }

        //Event handler
        $("#searchFilters input").change(function(){
            getSearchResults();
        });

        //Load initial results
        getSearchResults();